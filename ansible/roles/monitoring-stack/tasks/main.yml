- name: install docker and docker-compose
  apt:
    name:
      - docker.io
      - docker-compose
    state: present
    update_cache: yes

- name: ensure docker service is enabled and started
  systemd:
    name: docker
    enabled: yes
    state: started

- name: create monitoring directory
  file:
    path: /home/{{ ansible_user }}/monitoring
    state: directory
    mode: '0755'

- name: create docker-compose.yml
  copy:
    dest: /home/{{ ansible_user }}/monitoring/docker-compose.yml
    content: |
      version: "3.7"
      services:
        prometheus:
          image: prom/prometheus:latest
          volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
          ports:
            - "9090:9090"
          restart: unless-stopped

        grafana:
          image: grafana/grafana-oss
          ports:
            - "3000:3000"
          environment:
            - GF_SECURITY_ADMIN_PASSWORD=admin
          volumes:
            - grafana-data:/var/lib/grafana
          restart: unless-stopped

        loki:
          image: grafana/loki:2.8.2
          ports:
            - "3100:3100"
          restart: unless-stopped

      volumes:
        grafana-data:

- name: create prometheus.yml
  copy:
    dest: /home/{{ ansible_user }}/monitoring/prometheus.yml
    content: |
      global:
        scrape_interval: 15s

      scrape_configs:
        - job_name: 'node_exporter'
          static_configs:
            - targets: ['192.168.30.5:9100', '192.168.30.6:9100', '192.168.30.7:9100']

- name: launch monitoring stack
  command: docker-compose up -d
  args:
    chdir: /home/{{ ansible_user }}/monitoring
