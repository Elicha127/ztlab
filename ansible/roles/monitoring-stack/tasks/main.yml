---
- name: install docker and docker-compose
  apt:
    name:
      - docker.io
      - docker-compose
    state: present
    update_cache: yes

- name: ensure docker service is enabled and started
  systemd:
    name: docker
    enabled: yes
    state: started

- name: create monitoring directory
  file:
    path: /home/{{ ansible_user }}/monitoring
    state: directory
    mode: '0755'

- name: create docker-compose.yml with Alertmanager
  copy:
    dest: /home/{{ ansible_user }}/monitoring/docker-compose.yml
    content: |
      version: "3.7"
      services:
        prometheus:
          image: prom/prometheus:latest
          volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - ./alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
          command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.enable-lifecycle'
          ports:
            - "9090:9090"
          restart: unless-stopped

        alertmanager:
          image: prom/alertmanager:latest
          volumes:
            - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
          command:
            - '--config.file=/etc/alertmanager/alertmanager.yml'
            - '--storage.path=/alertmanager'
          ports:
            - "9093:9093"
          restart: unless-stopped

        grafana:
          image: grafana/grafana-oss
          ports:
            - "3000:3000"
          environment:
            - GF_SECURITY_ADMIN_PASSWORD=admin
          volumes:
            - grafana-data:/var/lib/grafana
          restart: unless-stopped

        loki:
          image: grafana/loki:2.8.2
          ports:
            - "3100:3100"
          restart: unless-stopped

      volumes:
        grafana-data:
  notify: restart monitoring stack

- name: render prometheus.yml from template
  template:
    src: prometheus.yml.j2
    dest: /home/{{ ansible_user }}/monitoring/prometheus.yml
    mode: '0644'
  notify: restart monitoring stack

- name: create alert_rules.yml
  copy:
    src: alert_rules.yml
    dest: /home/{{ ansible_user }}/monitoring/alert_rules.yml
  notify: restart monitoring stack


- name: create alertmanager.yml
  copy:
    src: alertmanager.yml
    dest: /home/{{ ansible_user }}/monitoring/alertmanager.yml
  notify: restart monitoring stack

- name: launch monitoring stack
  command: docker-compose up -d
  args:
    chdir: /home/{{ ansible_user }}/monitoring
