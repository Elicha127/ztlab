---
# ============================================================================
# Ã‰TAPE 7 : VALIDATION DÃ‰PLOIEMENT
# Tests fonctionnels et rapport
# ============================================================================

# ============================================================================
# TEST SERVICES SYSTÃˆME
# ============================================================================

- name: "ğŸ” VÃ©rification service Apache"
  systemd:
    name: apache2
    state: started
  register: apache_status

- name: "ğŸ” VÃ©rification service MariaDB"
  systemd:
    name: mariadb
    state: started
  register: mariadb_status

- name: "âœ… Services systÃ¨me opÃ©rationnels"
  debug:
    msg:
      - "Apache2  : {{ 'Actif âœ…' if apache_status.status.ActiveState == 'active' else 'Inactif âŒ' }}"
      - "MariaDB  : {{ 'Actif âœ…' if mariadb_status.status.ActiveState == 'active' else 'Inactif âŒ' }}"

# ============================================================================
# TEST CONNECTIVITÃ‰ HTTP
# ============================================================================

- name: "ğŸŒ Test accÃ¨s HTTP Nextcloud"
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ nextcloud_http_port }}/status.php"
    method: GET
    return_content: yes
    timeout: 10
  register: nc_http_test
  failed_when: false

- name: "ğŸ“Š Statut HTTP"
  debug:
    msg: "{{ nc_http_test.json if nc_http_test.status == 200 else 'Ã‰chec connexion HTTP' }}"

- name: "âœ… Validation accÃ¨s web"
  assert:
    that:
      - nc_http_test.status == 200
      - nc_http_test.json.installed == true
    success_msg: "âœ… Nextcloud accessible via HTTP"
    fail_msg: "âŒ Nextcloud inaccessible"

# ============================================================================
# TEST COMMANDE OCC
# ============================================================================

- name: "âš™ï¸  Test commande occ"
  command: php {{ nextcloud_install_dir }}/occ status --output=json
  register: occ_status
  become_user: "{{ nextcloud_web_user }}"
  changed_when: false

- name: "ğŸ“Š Statut Nextcloud (occ)"
  debug:
    msg: "{{ occ_status.stdout | from_json }}"

# ============================================================================
# VÃ‰RIFICATION BASE DE DONNÃ‰ES
# ============================================================================

- name: "ğŸ—„ï¸  Test connexion base de donnÃ©es"
  command: |
    mysql -u {{ nextcloud_db_user }} -p{{ nextcloud_db_password }} \
    -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='{{ nextcloud_db_name }}';"
  register: db_tables
  changed_when: false
  no_log: true

- name: "ğŸ“Š Tables base de donnÃ©es"
  debug:
    msg: "{{ db_tables.stdout_lines[-1] }} tables dans {{ nextcloud_db_name }}"

# ============================================================================
# RAPPORT FINAL
# ============================================================================

- name: "ğŸ“‹ GÃ©nÃ©ration rapport dÃ©ploiement"
  copy:
    content: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      RAPPORT DE DÃ‰PLOIEMENT NEXTCLOUD
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      Date           : {{ ansible_date_time.iso8601 }}
      Serveur        : {{ inventory_hostname }} ({{ ansible_default_ipv4.address }})
      Version        : Nextcloud {{ nextcloud_version }}
      Mode           : {{ 'OFFLINE' if offline_mode else 'ONLINE' }}
      
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      CONFIGURATION
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      URL            : http://{{ ansible_default_ipv4.address }}:{{ nextcloud_http_port }}
      Admin          : {{ nextcloud_admin_user }}
      
      RÃ©pertoires:
        Application  : {{ nextcloud_install_dir }}
        DonnÃ©es      : {{ nextcloud_data_dir }}
      
      Base de donnÃ©es:
        Nom          : {{ nextcloud_db_name }}
        Utilisateur  : {{ nextcloud_db_user }}
        HÃ´te         : {{ nextcloud_db_host }}
      
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      STATUT SERVICES
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      Apache2        : {{ 'Actif âœ…' if apache_status.status.ActiveState == 'active' else 'Inactif âŒ' }}
      MariaDB        : {{ 'Actif âœ…' if mariadb_status.status.ActiveState == 'active' else 'Inactif âŒ' }}
      Nextcloud      : {{ 'InstallÃ© âœ…' if nc_http_test.status == 200 else 'Erreur âŒ' }}
      
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      TESTS DE VALIDATION
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      HTTP Status    : {{ nc_http_test.status }}
      OCC Command    : {{ 'OK âœ…' if occ_status.rc == 0 else 'Erreur âŒ' }}
      Database Tables: {{ db_tables.stdout_lines[-1] if db_tables.rc == 0 else 'N/A' }}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ¯ DÃ©ploiement rÃ©ussi !
      
      AccÃ¨s Nextcloud :
        1. Ouvrir navigateur
        2. http://{{ ansible_default_ipv4.address }}:{{ nextcloud_http_port }}
        3. Se connecter : {{ nextcloud_admin_user }} / {{ nextcloud_admin_password }}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    dest: "/tmp/nextcloud-deploy-{{ ansible_date_time.epoch }}.txt"
    mode: '0644'

- name: "âœ… VALIDATION TERMINÃ‰E"
  debug:
    msg:
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘                                                               â•‘"
      - "â•‘         âœ… NEXTCLOUD OPÃ‰RATIONNEL                             â•‘"
      - "â•‘                                                               â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ”— URL : http://{{ ansible_default_ipv4.address }}:{{ nextcloud_http_port }}"
      - "ğŸ‘¤ User: {{ nextcloud_admin_user }}"
      - ""
