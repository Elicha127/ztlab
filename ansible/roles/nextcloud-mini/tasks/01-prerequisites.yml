---
# ============================================================================
# √âTAPE 1 : V√âRIFICATION PR√âREQUIS
# Validation environnement avant d√©ploiement
# ============================================================================

- name: "üîç D√©tection version PHP install√©e"
  shell: php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;'
  register: php_version_detect
  changed_when: false
  failed_when: false

- name: "üìå D√©finition version PHP"
  set_fact:
    php_version: "{{ php_version_detect.stdout | default('8.1') }}"

- name: "‚úÖ Version PHP cibl√©e"
  debug:
    msg: "PHP {{ php_version }} sera utilis√©"


# ============================================================================
# V√âRIFICATION CACHE OFFLINE (si mode offline activ√©)
# ============================================================================

- name: "üì¶ V√©rification cache offline"
  when: offline_mode
  block:
    - name: "V√©rification pr√©sence cache sur controller"
      delegate_to: controller
      become: no
      stat:
        path: "{{ cache_base_dir }}/archives/nextcloud-{{ nextcloud_version }}.tar.bz2"
      register: cache_check

    - name: "‚ùå Erreur : cache manquant"
      fail:
        msg: |
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          ‚ùå MODE OFFLINE ACTIV√â MAIS CACHE ABSENT !
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          Le cache doit √™tre pr√©par√© avec :
            ansible-playbook playbooks/prepare-offline-cache.yml
          
          Chemin attendu : {{ cache_base_dir }}/archives/
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      when: not cache_check.stat.exists

    - name: "‚úÖ Cache offline disponible"
      debug:
        msg: "Cache trouv√© : {{ cache_check.stat.path }}"

# ============================================================================
# V√âRIFICATION ESPACE DISQUE
# ============================================================================

- name: "üíæ V√©rification espace disque disponible"
  shell: df -BG /var | tail -1 | awk '{print $4}' | sed 's/G//'
  register: disk_space
  changed_when: false

- name: "‚úÖ Validation espace disque (minimum 5 GB)"
  assert:
    that:
      - disk_space.stdout | int >= 5
    fail_msg: |
      ‚ùå Espace disque insuffisant !
      Disponible : {{ disk_space.stdout }} GB
      Requis     : 5 GB minimum
    success_msg: "‚úÖ Espace disque OK : {{ disk_space.stdout }} GB disponibles"

# ============================================================================
# V√âRIFICATION PORT DISPONIBLE
# ============================================================================

- name: "üîå V√©rification port {{ nextcloud_http_port }} disponible"
  wait_for:
    port: "{{ nextcloud_http_port }}"
    state: stopped
    timeout: 2
  ignore_errors: yes
  register: port_check

- name: "‚ö†Ô∏è  Avertissement port occup√©"
  debug:
    msg: |
      ‚ö†Ô∏è  Le port {{ nextcloud_http_port }} semble d√©j√† utilis√©.
      Le d√©ploiement continuera mais pourrait n√©cessiter un ajustement.
  when: port_check.failed | default(false)

# ============================================================================
# CR√âATION R√âPERTOIRES DE BASE
# ============================================================================

- name: "üìÅ Cr√©ation r√©pertoires syst√®me"
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ nextcloud_data_dir }}"
    - "/tmp/nextcloud-install"

- name: "‚úÖ Pr√©requis valid√©s"
  debug:
    msg: "Tous les pr√©requis sont satisfaits, d√©ploiement autoris√©"
