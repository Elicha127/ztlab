---
# ============================================================================
# √âTAPE 3 : CONFIGURATION BASE DE DONN√âES MARIADB
# Cr√©ation base et utilisateur pour Nextcloud
# ============================================================================

- name: "üîê S√©curisation installation MariaDB"
  block:
    # V√©rifier si mot de passe root existe d√©j√†
    - name: "Test connexion root sans mot de passe"
      command: mysql -u root -e "SELECT 1"
      register: mysql_test
      failed_when: false
      changed_when: false
      no_log: true

    # D√©finir mot de passe root si premi√®re installation
    - name: "D√©finition mot de passe root MariaDB"
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock
        state: present
      when: mysql_test.rc == 0
      no_log: true

    # Suppression utilisateurs anonymes
    - name: "Suppression utilisateurs anonymes"
      mysql_user:
        name: ''
        host_all: yes
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"
      no_log: true
      ignore_errors: yes

    # Suppression base test
    - name: "Suppression base de donn√©es test"
      mysql_db:
        name: test
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"
      ignore_errors: yes

# ============================================================================
# CR√âATION BASE NEXTCLOUD
# ============================================================================

- name: "üóÑÔ∏è  Cr√©ation base de donn√©es {{ nextcloud_db_name }}"
  mysql_db:
    name: "{{ nextcloud_db_name }}"
    state: present
    encoding: utf8mb4
    collation: utf8mb4_general_ci
    login_user: root
    login_password: "{{ mysql_root_password }}"
  register: db_created

- name: "üë§ Cr√©ation utilisateur {{ nextcloud_db_user }}"
  mysql_user:
    name: "{{ nextcloud_db_user }}"
    password: "{{ nextcloud_db_password }}"
    priv: "{{ nextcloud_db_name }}.*:ALL"
    host: localhost
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
  no_log: true
  register: user_created

# ============================================================================
# VALIDATION
# ============================================================================

- name: "üîç Test connexion base de donn√©es"
  command: |
    mysql -u {{ nextcloud_db_user }} -p{{ nextcloud_db_password }} \
    -e "USE {{ nextcloud_db_name }}; SELECT 1;"
  register: db_test
  changed_when: false
  no_log: true

- name: "‚úÖ Base de donn√©es configur√©e"
  debug:
    msg:
      - "Base de donn√©es : {{ nextcloud_db_name }}"
      - "Utilisateur     : {{ nextcloud_db_user }}"
      - "Statut          : {{ 'Cr√©√©e' if db_created.changed else 'Existante' }}"
      - "Connexion       : ‚úÖ Valid√©e"
