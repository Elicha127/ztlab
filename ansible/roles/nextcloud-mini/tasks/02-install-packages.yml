---
# ============================================================================
# √âTAPE 2 : INSTALLATION PAQUETS SYST√àME
# Installation Apache, PHP, MariaDB
# ============================================================================

- name: "üì¶ Mode installation : {{ 'OFFLINE (cache local)' if offline_mode else 'ONLINE (d√©p√¥ts)' }}"
  debug:
    msg: "M√©thode d'installation d√©finie"

# ============================================================================
# MODE ONLINE : Installation depuis d√©p√¥ts Ubuntu
# ============================================================================

- name: "üì• Installation paquets (mode online)"
  when: not offline_mode
  block:
    - name: "Mise √† jour cache APT"
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: "Installation paquets syst√®me"
      apt:
        name:
          - apache2
          - libapache2-mod-php
          - mariadb-server
          - "php{{ php_version }}-fpm"
          - "php{{ php_version }}-mysql"
          - "php{{ php_version }}-gd"
          - "php{{ php_version }}-curl"
          - "php{{ php_version }}-xml"
          - "php{{ php_version }}-zip"
          - "php{{ php_version }}-mbstring"
          - "php{{ php_version }}-intl"
          - "php{{ php_version }}-bcmath"
          - "php{{ php_version }}-gmp"
          - "php{{ php_version }}-imagick"
          - python3-pymysql
          - bzip2
        state: present
      register: pkg_install_online

# ============================================================================
# MODE OFFLINE : Installation depuis cache local
# ============================================================================

- name: "üì¶ Installation paquets (mode offline)"
  when: offline_mode
  block:
    - name: "Copie cache .deb depuis controller"
      synchronize:
        src: "{{ cache_base_dir }}/packages/"
        dest: "/tmp/nextcloud-deb-cache/"
        rsync_opts:
          - "--ignore-existing"
      delegate_to: controller

    - name: "Installation paquets depuis cache local"
      apt:
        deb: "{{ item }}"
        state: present
      with_fileglob:
        - "/tmp/nextcloud-deb-cache/*.deb"
      register: pkg_install_offline
      ignore_errors: yes

    - name: "R√©solution d√©pendances manquantes"
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - apache2
        - mariadb-server
        - "php{{ php_version }}"
        - libapache2-mod-php
      ignore_errors: yes

# ============================================================================
# D√âMARRAGE SERVICES
# ============================================================================

- name: "üîÑ D√©marrage et activation services"
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - apache2
    - mariadb

# ============================================================================
# VALIDATION INSTALLATION
# ============================================================================

- name: "üîç V√©rification version PHP install√©e"
  command: php -v
  register: php_check
  changed_when: false

- name: "üìä Version PHP install√©e"
  debug:
    msg: "{{ php_check.stdout_lines[0] }}"

- name: "‚úÖ Paquets install√©s avec succ√®s"
  debug:
    msg: "Installation termin√©e - Services d√©marr√©s"
