---
# ============================================================================
# PRÃ‰PARATION CACHE OFFLINE NEXTCLOUD
# Ã€ exÃ©cuter UNE FOIS avec connexion Internet
# ============================================================================

- name: "ğŸ“¦ PrÃ©paration cache offline Nextcloud"
  hosts: controller
  gather_facts: yes
  become: yes
  
  vars:
    cache_base_dir: "/opt/ansible-cache/nextcloud"
    nextcloud_version: "28.0.1"
    nextcloud_url: "https://download.nextcloud.com/server/releases/nextcloud-{{ nextcloud_version }}.tar.bz2"
    
  tasks:
    - name: "ğŸ“¢ Information prÃ©paration"
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                                                               â•‘"
          - "â•‘        PRÃ‰PARATION CACHE OFFLINE NEXTCLOUD                    â•‘"
          - "â•‘                                                               â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Version Nextcloud : {{ nextcloud_version }}"
          - "Destination cache : {{ cache_base_dir }}"
          - ""
          - "âš ï¸  Connexion Internet requise !"
          - "â±ï¸  DurÃ©e estimÃ©e : 5-10 minutes"
          - ""

    # ========================================================================
    # CRÃ‰ATION STRUCTURE CACHE
    # ========================================================================
    
    - name: "ğŸ“ CrÃ©ation structure de cache"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ cache_base_dir }}"
        - "{{ cache_base_dir }}/archives"
        - "{{ cache_base_dir }}/packages"

    # ========================================================================
    # TÃ‰LÃ‰CHARGEMENT ARCHIVE NEXTCLOUD
    # ========================================================================
    
    - name: "ğŸ“¥ TÃ©lÃ©chargement Nextcloud {{ nextcloud_version }}"
      get_url:
        url: "{{ nextcloud_url }}"
        dest: "{{ cache_base_dir }}/archives/nextcloud-{{ nextcloud_version }}.tar.bz2"
        timeout: 600
      register: nc_download

    - name: "âœ… Archive Nextcloud tÃ©lÃ©chargÃ©e"
      debug:
        msg:
          - "Fichier : {{ nc_download.dest }}"
          - "Taille  : {{ (nc_download.size | int / 1024 / 1024) | round(1) }} MB"

    # ========================================================================
    # TÃ‰LÃ‰CHARGEMENT PAQUETS .DEB
    # ========================================================================
    
    - name: "ğŸ“¥ TÃ©lÃ©chargement paquets systÃ¨me (.deb)"
      apt:
        name:
          - apache2
          - libapache2-mod-php
          - mariadb-server
          - php-fpm
          - php-mysql
          - php-gd
          - php-curl
          - php-xml
          - php-zip
          - php-mbstring
          - php-intl
          - php-bcmath
          - php-gmp
          - php-imagick
          - python3-pymysql
          - bzip2
        state: present
        download_only: yes
      register: pkg_download

    - name: "ğŸ“¦ Copie paquets dans cache"
      shell: |
        mkdir -p {{ cache_base_dir }}/packages
        find /var/cache/apt/archives -name "*.deb" -newer /var/cache/apt/pkgcache.bin \
          -exec cp {} {{ cache_base_dir }}/packages/ \; 2>/dev/null || true
      changed_when: false

    # ========================================================================
    # VALIDATION CACHE
    # ========================================================================
    
    - name: "âœ… Comptage fichiers .deb"
      find:
        paths: "{{ cache_base_dir }}/packages"
        patterns: "*.deb"
      register: deb_files

    - name: "âœ… VÃ©rification archive Nextcloud"
      stat:
        path: "{{ cache_base_dir }}/archives/nextcloud-{{ nextcloud_version }}.tar.bz2"
      register: nc_archive

    # ========================================================================
    # CRÃ‰ATION ARCHIVE DE BACKUP
    # ========================================================================
    
    - name: "ğŸ’¾ CrÃ©ation archive de backup complÃ¨te"
      archive:
        path: "{{ cache_base_dir }}"
        dest: "/tmp/nextcloud-offline-cache-{{ ansible_date_time.date }}.tar.gz"
        format: gz
      register: backup_archive

    # ========================================================================
    # RÃ‰SULTAT FINAL
    # ========================================================================
    
    - name: "ğŸ‰ Cache offline prÃªt"
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                                                               â•‘"
          - "â•‘           âœ… CACHE OFFLINE PRÃŠT !                             â•‘"
          - "â•‘                                                               â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“¦ Contenu du cache :"
          - "   â€¢ Archive Nextcloud  : {{ (nc_archive.stat.size | int / 1024 / 1024) | round(1) }} MB"
          - "   â€¢ Paquets .deb       : {{ deb_files.matched }} fichiers"
          - ""
          - "ğŸ“ Emplacement :"
          - "   {{ cache_base_dir }}/"
          - ""
          - "ğŸ’¾ Archive de backup :"
          - "   {{ backup_archive.dest }}"
          - "   Taille : {{ (backup_archive.archived | length) }} fichiers"
          - ""
          - "ğŸ¯ PrÃªt pour dÃ©ploiement offline !"
          - ""
          - "ğŸ’¡ Conseil : Copiez l'archive sur clÃ© USB de secours"
          - "   cp {{ backup_archive.dest }} /media/usb/"
          - ""
