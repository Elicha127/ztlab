---
# ============================================================================
# ROLLBACK COMPLET NEXTCLOUD
# Suppression totale pour permettre nouveau dÃ©ploiement
# ============================================================================

- name: "ğŸ—‘ï¸  Rollback Nextcloud complet"
  hosts: apps
  gather_facts: yes
  become: yes
  
  vars:
    # Reprendre les mÃªmes variables que le rÃ´le
    nextcloud_install_dir: "/var/www/nextcloud"
    nextcloud_data_dir: "/var/www/nextcloud-data"
    nextcloud_db_name: "nextcloud_db"
    nextcloud_db_user: "nextcloud_user"
    mysql_root_password: "RootNextcloud2024!"
    nextcloud_http_port: 8080

  pre_tasks:
    - name: "âš ï¸  Confirmation suppression"
      pause:
        prompt: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš ï¸  ATTENTION - OPÃ‰RATION DESTRUCTIVE
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Cette opÃ©ration va SUPPRIMER dÃ©finitivement :
            â€¢ Application Nextcloud complÃ¨te
            â€¢ Base de donnÃ©es {{ nextcloud_db_name }}
            â€¢ Tous les fichiers utilisateurs
            â€¢ Configuration Apache VirtualHost
            â€¢ Fichiers temporaires
          
          Serveur cible : {{ inventory_hostname }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Appuyez sur ENTRÃ‰E pour confirmer ou CTRL+C pour annuler
      delegate_to: localhost
      run_once: yes

  tasks:
    # ========================================================================
    # ARRÃŠT DES SERVICES
    # ========================================================================
    
    - name: "ğŸ›‘ ArrÃªt service Apache2"
      systemd:
        name: apache2
        state: stopped
      ignore_errors: yes

    - name: "ğŸ›‘ ArrÃªt service MariaDB"
      systemd:
        name: mariadb
        state: stopped
      ignore_errors: yes

    # ========================================================================
    # SUPPRESSION CONFIGURATION APACHE
    # ========================================================================
    
    - name: "ğŸ—‘ï¸  Suppression VirtualHost Nextcloud"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apache2/sites-enabled/nextcloud.conf
        - /etc/apache2/sites-available/nextcloud.conf

    - name: "ğŸ”„ Restauration port Apache par dÃ©faut"
      lineinfile:
        path: /etc/apache2/ports.conf
        regexp: "^Listen {{ nextcloud_http_port }}"
        line: "Listen 80"
      when: nextcloud_http_port != 80

    - name: "ğŸ”— RÃ©activation site par dÃ©faut Apache"
      file:
        src: /etc/apache2/sites-available/000-default.conf
        dest: /etc/apache2/sites-enabled/000-default.conf
        state: link
      ignore_errors: yes

    # ========================================================================
    # SUPPRESSION BASE DE DONNÃ‰ES
    # ========================================================================
    
    - name: "ğŸ”„ RedÃ©marrage MariaDB pour suppression"
      systemd:
        name: mariadb
        state: started
      ignore_errors: yes

    - name: "ğŸ—‘ï¸  Suppression utilisateur base de donnÃ©es"
      mysql_user:
        name: "{{ nextcloud_db_user }}"
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"
      ignore_errors: yes
      no_log: true

    - name: "ğŸ—‘ï¸  Suppression base de donnÃ©es Nextcloud"
      mysql_db:
        name: "{{ nextcloud_db_name }}"
        state: absent
        login_user: root
        login_password: "{{ mysql_root_password }}"
      ignore_errors: yes

    # ========================================================================
    # SUPPRESSION FICHIERS
    # ========================================================================
    
    - name: "ğŸ—‘ï¸  Suppression rÃ©pertoire application Nextcloud"
      file:
        path: "{{ nextcloud_install_dir }}"
        state: absent

    - name: "ğŸ—‘ï¸  Suppression rÃ©pertoire donnÃ©es Nextcloud"
      file:
        path: "{{ nextcloud_data_dir }}"
        state: absent

    - name: "ğŸ—‘ï¸  Suppression fichiers temporaires"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/nextcloud-install
        - /tmp/nextcloud.tar.bz2
        - /tmp/nextcloud-deb-cache

    - name: "ğŸ—‘ï¸  Suppression logs Apache Nextcloud"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/log/apache2/nextcloud_error.log
        - /var/log/apache2/nextcloud_access.log
      ignore_errors: yes

    - name: "ğŸ—‘ï¸  Suppression source APT locale (si mode offline)"
      file:
        path: /etc/apt/sources.list.d/nextcloud-local.list
        state: absent

    # ========================================================================
    # REDÃ‰MARRAGE SERVICES
    # ========================================================================
    
    - name: "ğŸ”„ RedÃ©marrage Apache2"
      systemd:
        name: apache2
        state: restarted
        enabled: yes
      ignore_errors: yes

    - name: "ğŸ”„ RedÃ©marrage MariaDB"
      systemd:
        name: mariadb
        state: restarted
        enabled: yes
      ignore_errors: yes

    # ========================================================================
    # VALIDATION SUPPRESSION
    # ========================================================================
    
    - name: "âœ… VÃ©rification suppression application"
      stat:
        path: "{{ nextcloud_install_dir }}"
      register: app_check

    - name: "âœ… VÃ©rification suppression donnÃ©es"
      stat:
        path: "{{ nextcloud_data_dir }}"
      register: data_check

    - name: "âœ… VÃ©rification suppression base de donnÃ©es"
      command: |
        mysql -u root -p{{ mysql_root_password }} \
        -e "SHOW DATABASES LIKE '{{ nextcloud_db_name }}';"
      register: db_check
      changed_when: false
      failed_when: false
      no_log: true

  post_tasks:
    - name: "ğŸ“Š Rapport de rollback"
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                                                               â•‘"
          - "â•‘              âœ… ROLLBACK TERMINÃ‰ AVEC SUCCÃˆS                  â•‘"
          - "â•‘                                                               â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š Ã‰lÃ©ments supprimÃ©s :"
          - "   â€¢ Application Nextcloud : {{ 'Oui âœ…' if not app_check.stat.exists else 'Non âŒ' }}"
          - "   â€¢ DonnÃ©es utilisateurs  : {{ 'Oui âœ…' if not data_check.stat.exists else 'Non âŒ' }}"
          - "   â€¢ Base de donnÃ©es       : {{ 'Oui âœ…' if db_check.stdout == '' else 'Non âŒ' }}"
          - "   â€¢ Configuration Apache  : Oui âœ…"
          - "   â€¢ Fichiers temporaires  : Oui âœ…"
          - ""
          - "ğŸ”„ Services actifs :"
          - "   â€¢ Apache2  : RedÃ©marrÃ©"
          - "   â€¢ MariaDB  : RedÃ©marrÃ©"
          - ""
          - "ğŸ¯ SystÃ¨me prÃªt pour nouveau dÃ©ploiement"
          - ""
          - "Pour redÃ©ployer :"
          - "   ansible-playbook playbooks/deploy-nextcloud.yml"
          - ""
      delegate_to: localhost
      run_once: yes
