---
- name: Deploy Postfix Mail Server on gt-mail
  hosts: gt-mail
  become: yes
  roles:
    - postfix
    - monitoring  # Install Node Exporter

  post_tasks:
    - name: Display mail server information
      debug:
        msg:
          - "Mail server deployed successfully!"
          - "FQDN: {{ fqdn }}"
          - "IP: {{ static_ip }}"
          - "SMTP: {{ static_ip }}:25"
          - "IMAP: {{ static_ip }}:143"
          - "POP3: {{ static_ip }}:110"
          - "Mail accounts created:"

    - name: Show mail accounts created
      debug:
        msg: "{{ mail_users | map(attribute='email') | list }}"

- name: Update Alertmanager with Postfix configuration
  hosts: monitoring
  become: yes
  tasks:
    - name: Update Alertmanager to use Postfix
      copy:
        dest: /home/{{ ansible_user }}/monitoring/alertmanager.yml
        content: |
          global:
            resolve_timeout: 5m
            smtp_from: 'alerts@germe-tech.local'
            smtp_smarthost: '192.168.40.10:25'
            smtp_require_tls: false
            smtp_hello: 'alertmanager.germe-tech.local'

          route:
            group_by: ['alertname', 'instance']
            group_wait: 10s
            group_interval: 10s
            repeat_interval: 12h
            receiver: 'default'
            routes:
              - match:
                  severity: critical
                receiver: 'critical-alerts'
              - match:
                  severity: warning
                receiver: 'warning-alerts'

          receivers:
            - name: 'default'
              email_configs:
                - to: 'admin@germe-tech.local'

            - name: 'critical-alerts'
              email_configs:
                - to: 'alerts@germe-tech.local,supervision@germe-tech.local'
              webhook_configs:
                - url: 'http://192.168.40.20:5000/alert'

            - name: 'warning-alerts'
              email_configs:
                - to: 'supervision@germe-tech.local'
      notify: restart alertmanager

  handlers:
    - name: restart alertmanager
      command: docker-compose restart alertmanager
      args:
        chdir: /home/{{ ansible_user }}/monitoring
